---
title: 為什麼記憶體滿了電腦還能跑？搞懂虛擬記憶體的魔法
date: 2025-04-12
category: basics
abstract: 打開幾個設計檔、開幾個軟體，16GB 的 RAM 很快就滿了。但你有沒有想過，為什麼電腦還沒當機？甚至還能撐著跑？本篇文章將用簡單比喻帶你理解虛擬記憶體（Virtual Memory）的運作方式，從分頁系統、頁表、到交換機制（Swapping），讓你一窺作業系統如何偷偷幫你把資源用到極致。
tags: [RAM, Virtual memory]
---

我們在挑選電腦時，常常都會去看他的記憶體（RAM）8G、16G，尤其做設計的一定會知道越大越好。但 16G 的容量分明在設計軟體開幾張大檔就滿，你有沒有想過為什麼電腦跑的起來呢？又或是如果同時開啟很多軟體的時候，電腦為什麼會變慢呢？我們今天來看看電腦的記憶體是如何運作的。

### 程式需要連續的記憶體空間

每開一個新的程式，記憶體都會分配一段連續的區段給它。你可以想像整個記憶體就像一條很長的街道，有連續 1 到 100 號的地址。假設住在這裡的都是有錢人，一次買了很多戶。如果他們都只能買連號的房子，那我只需要知道這個人從 1 號開始，買了 10 戶，就知道 1~10 號都是他家的了。如果他跳著買，1 號、5 號、16 號，這樣我就必須一個一個對照。基於程式的效率、便捷度，因此記憶體會分配連續的區段給他們。

我們看下圖，每個開啟的程式都佔據了記憶的一部分。

![6-1](/images/post/6-1.png)

一但關掉程式，記憶體並不會自動將他們往前放，就如同富人把他這條街上的連續 10 個門牌的房子都賣掉，其他人的地址也會因此改動。但如果今天，有一個新來的富人想買 12 間房子呢？已經沒有連續門牌可以給他了，這時候程式就會跟你說記憶體不足。但不是啊，所有的區段加起來，還是可以擠出他想要的 12 間房子，只是不是連續的區段。這時候怎麼辦呢？

![6-2](/images/post/6-2.png)
_(這三個 X 的區段加給來，明顯超過新來的程式想用的大小)_

---

### 虛擬記憶體

所以，為了解決「沒有連續記憶體但還是想塞進新程式」的問題，電腦發明了一種聰明的方式：虛擬記憶體（Virtual Memory）。
這個機制創造出一個「錯覺」：讓每個程式都以為自己擁有一大塊、連續的記憶體空間。但實際上，這些空間可能分散在實體記憶體（RAM）中，也可能被暫時放在硬碟裡。

![6-3](/images/post/6-3.png)

---

#### 虛擬記憶體如何運作？

我們用一個廚房的比喻來想像：

👉 **實體記憶體**就像是你家廚房的工作檯面，空間有限，只能放眼下要用的材料。
👉 **虛擬記憶體**就像是整個廚房，包括工作檯面、冰箱、櫥櫃，甚至地下儲藏室。
👉 所有材料（程式資料）都先分裝在一個個一樣大小的盒子裡（頁，Page），有需要時再拿出來用。

##### 分頁系統（Paging）：把材料一盒盒放好

作業系統會將虛擬記憶體劃分為固定大小的「頁（Page）」，通常每頁是 4KB；同樣地，實體記憶體也會被分成相同大小的「頁框（Page Frame）」。這樣就可以做到 一頁一頁地搬運資料，而不需要整段搬來搬去。

- 虛擬記憶體被分為一頁一頁（Page）

- 實體記憶體也被分為頁框（Page Frame）

- 按需分頁（Demand Paging）：只有當程式實際要用到某一頁時，才會將那頁載入實體記憶體

![6-4](/images/post/6-4.png)

---

##### 地址轉換（Page Table）：查材料在哪裡

每當程式想存取記憶體資料時，會經過一個轉換過程。
這就像你查食材放哪裡一樣 —— 你不會記得生菜放在哪裡，但有張清單（Page Table）幫你記住了。

這張 **頁表（Page Table）** 記錄每一頁的虛擬位址對應到哪個實體頁框（或硬碟中的備份），這樣電腦就可以把你要的東西拿出來。

這整個過程由一個硬體元件 **MMU（記憶體管理單元）** 自動處理，它通常整合在 CPU 裡面。

🔁 一個記憶體讀取流程可能長這樣：

```
程式要求讀取虛擬地址 0x00403000
↓
MMU 查 Page Table：0x00403 → Page Table Entry
↓
找到對應實體地址 0x1F00A000
↓
CPU 讀取 0x1F00A000 的資料
```

---

###### 頁面交換（Swapping）：冰箱來幫忙

當工作檯面（RAM）滿了，又有新的材料要進來，系統會先把**暫時用不到的頁放**回硬碟（稱為 Swap），騰出空間再把新頁放上來。

但硬碟的存取速度比 RAM 慢很多，如果你同時開太多程式、檔案，系統就會一直忙著搬來搬去（這稱為 **頻繁交換 Thrashing**），導致你感覺電腦卡卡的，甚至有點像廚師只顧著找材料、沒空做菜一樣。

---

當我們開啟很多程式、設計檔佔滿記憶體時，電腦並不是「真的」有這麼多 RAM 可以用，而是靠虛擬記憶體這一層魔術，讓每個程式以為自己有一大塊連續空間可以用。這背後的運作，其實就像把資料分頁、放進櫃子、冰箱，甚至地下室，必要時再拿出來。

了解這些原理後，我們就可以聰明地管理電腦資源！