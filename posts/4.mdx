---
title: JavaScript è¨˜æ†¶é«”é‹ä½œåŸç†èˆ‡åƒåœ¾å›æ”¶ï¼šä½ çœŸçš„æ‡‚ JS æ€éº¼é‡‹æ”¾è¨˜æ†¶é«”å—ï¼Ÿ
date: 2025-04-10
category: basics
abstract: JavaScript çœŸçš„å¹«ä½ å…¨è‡ªå‹•ç®¡ç†è¨˜æ†¶é«”å—ï¼Ÿäº†è§£ stackã€heapã€åƒåœ¾å›æ”¶æ©Ÿåˆ¶èˆ‡è¨˜æ†¶é«”æ´©æ¼çš„å¸¸è¦‹é™·é˜±ï¼Œè®“ä½ å¯«å‡ºæ›´ç©©å®šçš„ç¨‹å¼ã€‚
tags: [memory, garbage-collection, javascript, performance, heap-stack]
---

### è¨˜æ†¶é«”èˆ‡å„²å­˜çµæ§‹ï¼šJavaScript æ˜¯æ€éº¼å­˜è³‡æ–™çš„ï¼Ÿ

åœ¨ç¨‹å¼é‹ä½œçš„éç¨‹ä¸­ï¼Œè¨˜æ†¶é«”æ˜¯æˆ‘å€‘æš«æ™‚æ”¾è³‡æ–™çš„åœ°æ–¹ï¼Œåƒä½ åœ¨æ–™ç†æ™‚æŠŠé£Ÿææ”¾åœ¨æ–™ç†å°ä¸Šï¼Œè³‡æ–™å°±é€™æ¨£å…ˆæ“ºè‘—ã€ç”¨è‘—ï¼Œä¸€ç›´åˆ°ä½ ä¸å†éœ€è¦å®ƒã€‚

åœ¨ JavaScript è£¡ï¼Œé€™äº›è¨˜æ†¶é«”å¤§è‡´ä¸Šåˆ†æˆå…©å€‹å€å¡Šï¼š**æ£§ï¼ˆStackï¼‰ å’Œ å †ï¼ˆHeapï¼‰**ã€‚

##### æ£§ï¼ˆStackï¼‰ï¼š

- å„²å­˜**åŸºæœ¬è³‡æ–™**é¡å‹ï¼šæ•¸å­—ã€å¸ƒæ—å€¼ã€undefinedã€null ç­‰
- å¤§å°å›ºå®šä¸”æœ‰é™
- å„²å­˜å‡½æ•¸å‘¼å«å’Œå±€éƒ¨è®Šæ•¸
- ä¸€æ—¦å‡½å¼åŸ·è¡Œå®Œç•¢ï¼Œè£¡é¢çš„è³‡æ–™å°±æœƒå¾æ£§ä¸­è‡ªå‹•ç§»é™¤ã€‚
- è¨ªå•é€Ÿåº¦å¿«ï¼Œéµå¾ªå¾Œé€²å…ˆå‡ºï¼ˆLIFOï¼‰åŸå‰‡ï¼Œèˆ‰ä¾‹ä¾†èªªï¼š

```c
function calculate() {
  let x = 10;        // åŠ å…¥å †ç–Š
  let y = 20;        // åŠ å…¥å †ç–Š
  let result = x + y; // åŠ å…¥å †ç–Š
  return result;     // result é›¢é–‹å †ç–Š
                    // y é›¢é–‹å †ç–Š
                    // x é›¢é–‹å †ç–Š
}
```

_JavaScript å‡½æ•¸èª¿ç”¨éç¨‹æ™‚çš„ Call Stack (èª¿ç”¨å †ç–Š)ï¼Œä¹Ÿæ˜¯éµå¾ªå¾Œé€²å…ˆå‡ºï¼ˆLIFOï¼‰åŸå‰‡ï¼Œä½†å’Œæ­¤è™•çš„ Stack (è¨˜æ†¶é«”ä¸­çš„å †ç–Š) æœ‰æ‰€ä¸åŒã€‚_

##### å †ï¼ˆHeapï¼‰ï¼š

- çµæ§‹æ¯”è¼ƒéˆæ´»ï¼Œé©åˆå„²å­˜å¤§å‹æˆ–è¤‡é›œè³‡æ–™çµæ§‹ï¼Œåƒæ˜¯ç‰©ä»¶ï¼ˆobjectï¼‰ã€é™£åˆ—ï¼ˆarrayï¼‰ã€å‡½å¼ï¼ˆä¹Ÿæ˜¯ä¸€ç¨®ç‰©ä»¶ï¼‰ã€‚
- è³‡æ–™æœƒå­˜åœ¨è¨˜æ†¶é«”ä¸­çš„æŸå€‹ä½ç½®ï¼Œç„¶å¾Œè®Šæ•¸åªå„²å­˜é‚£å€‹ä½ç½®çš„åƒç…§ï¼ˆReferenceï¼‰ã€‚
- å‹•æ…‹åˆ†é…ç©ºé–“ï¼Œå¤§å°ä¸å›ºå®š
- è¨ªå•é€Ÿåº¦ç›¸å°è¼ƒæ…¢
- éœ€è¦åƒåœ¾å›æ”¶æ©Ÿåˆ¶ç®¡ç†

```c
let obj = { name: 'Alice' }  // obj çš„è³‡æ–™å­˜åœ¨ Heapï¼ŒStack ä¸­åªè¨˜ä½åƒç…§ä½ç½®
```

### åƒåœ¾å›æ”¶æ©Ÿåˆ¶ï¼ˆGarbage Collectionï¼‰

JavaScript è‡ªå‹•ç®¡ç†è¨˜æ†¶é«”ï¼Œä¸»è¦ä½¿ç”¨å…©ç¨®åƒåœ¾å›æ”¶æ¼”ç®—æ³•ï¼š

#### 1. æ¨™è¨˜-æ¸…é™¤ï¼ˆMark and Sweepï¼‰ï¼š

JavaScript æ¡ç”¨**è‡ªå‹•åƒåœ¾å›æ”¶æ©Ÿåˆ¶**ï¼Œæœ€å¸¸è¦‹çš„æ˜¯**æ¨™è¨˜æ¸…é™¤æ³•**ï¼Œå®ƒæ˜¯ä¸€ç¨®æ›´è¤‡é›œä½†ä¹Ÿæ›´æœ‰æ•ˆçš„åƒåœ¾å›æ”¶æ–¹å¼ï¼Œä¸ä¾è³´ç°¡å–®çš„å¼•ç”¨è¨ˆæ•¸ï¼ˆç­‰ç­‰æœƒä»‹ç´¹ï¼‰ï¼Œå› æ­¤èƒ½å¤ è§£æ±ºå¾ªç’°å¼•ç”¨å•é¡Œã€‚é€™å€‹ç®—æ³•åˆ†ç‚ºå…©å€‹ä¸»è¦éšæ®µï¼š

1. **æ¨™è¨˜éšæ®µï¼ˆMark Phaseï¼‰**
   åƒåœ¾å›æ”¶å™¨é¦–å…ˆå®šç¾©ä¸€äº›æ ¹ç¯€é»ï¼ˆrootsï¼‰ï¼š

  - å…¨åŸŸç‰©ä»¶ï¼ˆå¦‚ç€è¦½å™¨ä¸­çš„ window æˆ– Node.js ä¸­çš„ globalï¼‰
  - ç›®å‰åŸ·è¡Œçš„å‡½æ•¸çš„å±€éƒ¨è®Šæ•¸å’Œåƒæ•¸
  - æ­£åœ¨åŸ·è¡Œçš„é–‰åŒ…ä¸­çš„è®Šæ•¸

     ç„¶å¾Œï¼Œå›æ”¶å™¨éè¿´åœ°è¿½è¹¤å¾é€™äº›æ ¹å‡ºç™¼å¯ä»¥è¨ªå•åˆ°çš„æ‰€æœ‰ç‰©ä»¶ï¼Œä¸¦æ¨™è¨˜å®ƒå€‘ç‚ºã€Œåœ¨ä½¿ç”¨ä¸­ã€ã€‚

2. **æ¸…é™¤éšæ®µï¼ˆSweep Phaseï¼‰**
   æ¨™è¨˜å®Œæˆå¾Œï¼Œåƒåœ¾å›æ”¶å™¨éæ­·æ•´å€‹å †è¨˜æ†¶é«”ï¼š

  - å¦‚æœç‰©ä»¶è¢«æ¨™è¨˜ç‚ºã€Œåœ¨ä½¿ç”¨ä¸­ã€ï¼Œå‰‡ä¿ç•™
  - å¦‚æœç‰©ä»¶æœªè¢«æ¨™è¨˜ï¼Œå‰‡èªç‚ºå®ƒæ˜¯ã€Œæ²’åœ¨ä½¿ç”¨ã€çš„åƒåœ¾ï¼Œå¯ä»¥è¢«å›æ”¶

æˆ‘å€‘å¯¦éš›èˆ‰å€‹ä¾‹å­ä¾†èªªï¼š

```c
let objectA = {};
let objectB = {};

objectA.refToB = objectB;
objectB.refToA = objectA;

// æ–·é–‹å¤–éƒ¨å¼•ç”¨
objectA = null;
objectB = null;
```

æ¨™è¨˜-æ¸…é™¤ç®—æ³•è™•ç†é€™å€‹æƒ…æ³çš„æ–¹å¼ï¼š

**æ¨™è¨˜éšæ®µ**ï¼š

1. å¾æ ¹ï¼ˆä¾‹å¦‚å…¨åŸŸè®Šæ•¸ï¼‰é–‹å§‹
2. ç•¶ objectA å’Œ objectB è¢«è¨­ç‚º null å¾Œï¼Œå¾æ ¹ç„¡æ³•åˆ°é”é€™å…©å€‹ç‰©ä»¶
3. å³ä½¿å®ƒå€‘äº’ç›¸å¼•ç”¨ï¼Œä½†å› ç‚ºç„¡æ³•å¾æ ¹è¨ªå•åˆ°ï¼Œæ‰€ä»¥éƒ½ä¸æœƒè¢«æ¨™è¨˜

**æ¸…é™¤éšæ®µ**ï¼š

4. æœªè¢«æ¨™è¨˜çš„ objectA å’Œ objectB è¢«è­˜åˆ¥ç‚ºåƒåœ¾
5. é€™å…©å€‹ç‰©ä»¶éƒ½è¢«å›æ”¶ï¼Œå³ä½¿å®ƒå€‘äº’ç›¸å¼•ç”¨

é€™å°±æ˜¯æ¨™è¨˜-æ¸…é™¤ç®—æ³•çš„å„ªå‹¢ï¼š **å®ƒä¸é—œå¿ƒç‰©ä»¶ä¹‹é–“çš„å¼•ç”¨é—œä¿‚ï¼Œåªé—œå¿ƒç‰©ä»¶æ˜¯å¦å¯ä»¥å¾æ ¹è¨ªå•åˆ°ã€‚** å¦‚æœä¸€çµ„ç‰©ä»¶å½¢æˆäº†å¾ªç’°å¼•ç”¨ï¼Œä½†ç„¡æ³•å¾æ ¹åˆ°é”ï¼Œé‚£éº¼æ•´å€‹å¾ªç’°éƒ½æœƒè¢«å›æ”¶ã€‚

#### 2. å¼•ç”¨è¨ˆæ•¸ï¼ˆReference Countingï¼‰ï¼š

æ¯å€‹ç‰©ä»¶æœ‰ä¸€å€‹ã€Œè¨ˆæ•¸å™¨ã€ï¼Œè¨˜éŒ„å®ƒè¢«å¼•ç”¨çš„æ¬¡æ•¸ã€‚

ç•¶è¨ˆæ•¸å™¨ç‚º 0ï¼ˆæ²’äººåƒè€ƒï¼‰ï¼Œè©²ç‰©ä»¶å°±å¯ä»¥è¢«æ¸…é™¤ã€‚

##### ç¼ºé»ï¼šå®¹æ˜“å‡ºç¾å¾ªç’°å¼•ç”¨ï¼ˆcircular referenceï¼‰å°è‡´è¨˜æ†¶é«”æ´©æ¼

```c
const a = {}
const b = {}
a.b = b
b.a = a
// é›–ç„¶æ²’æœ‰ç”¨åˆ°ï¼Œä½†å½¼æ­¤åƒç…§ï¼Œè¨ˆæ•¸æ°¸é ä¸ç‚º 0
```

##### è§£æ±ºæ–¹æ¡ˆï¼šç¾ä»£å¼•æ“ä¸å–®ç´”ä¾è³´é€™ç¨®æ–¹å¼ï¼Œè€Œæ˜¯çµåˆã€Œæ¨™è¨˜-æ¸…é™¤ã€è™•ç†å¾ªç’°å¼•ç”¨ã€‚

--- 

### V8 å¼•æ“çš„æ”¹é€²

ç¾ä»£ JavaScript å¼•æ“å¦‚ V8ï¼ˆChrome å’Œ Node.js ä½¿ç”¨çš„å¼•æ“ï¼‰é€²ä¸€æ­¥æ”¹é€²äº†æ¨™è¨˜-æ¸…é™¤ç®—æ³•ï¼š

#### åˆ†ä»£å›æ”¶ï¼ˆGenerational Collectionï¼‰ï¼š

å°‡è¨˜æ†¶é«”åŠƒåˆ†ç‚ºã€Œæ–°ç”Ÿä»£ã€å’Œã€Œè€ç”Ÿä»£ã€ï¼Œ
æ–°å»ºç«‹çš„ç‰©ä»¶æœƒå…ˆé€²å…¥æ–°ç”Ÿä»£ï¼Œç¶“éå¹¾æ¬¡åƒåœ¾å›æ”¶å¾Œä»ç„¶å­˜æ´»çš„ç‰©ä»¶è¢«ç§»è‡³è€ç”Ÿä»£ï¼Œæ–°ç”Ÿä»£ä½¿ç”¨ Scavenge ç®—æ³•**å¿«é€Ÿå›æ”¶**ã€‚
è€ç”Ÿä»£ä½¿ç”¨æ›´å®Œæ•´çš„ Mark-and-Sweep ç®—æ³•ï¼Œä»¥æå‡æ•ˆèƒ½ï¼Œé¿å…æ•´å€‹æ‡‰ç”¨éƒ½è¢«ä¸­æ–·ä¾†æ¸…ç†è¨˜æ†¶é«”ã€‚

#### å¢é‡æ¨™è¨˜ï¼ˆIncremental Markingï¼‰ï¼š

å°‡æ¨™è¨˜éç¨‹åˆ†è§£æˆå°å¡Šï¼Œèˆ‡ JavaScript åŸ·è¡Œäº¤æ›¿é€²è¡Œï¼Œæ¸›å°‘å› åƒåœ¾å›æ”¶é€ æˆçš„é•·æ™‚é–“æš«åœã€‚

#### æ‡¶æ€§æ¸…é™¤ï¼ˆLazy Sweepingï¼‰ï¼š

ä¸ç«‹å³æ¸…é™¤æ‰€æœ‰æœªæ¨™è¨˜çš„ç‰©ä»¶ï¼Œæ ¹æ“šéœ€è¦é€æ­¥æ¸…é™¤ï¼Œæ¸›å°‘æš«åœæ™‚é–“

#### ä¸¦è¡Œè™•ç†ï¼ˆConcurrent Processingï¼‰ï¼š

åœ¨èƒŒæ™¯ç·šç¨‹ä¸­é€²è¡Œéƒ¨åˆ†åƒåœ¾å›æ”¶å·¥ä½œï¼Œä¸»ç·šç¨‹å¯ä»¥ç¹¼çºŒåŸ·è¡Œ JavaScript ä»£ç¢¼ã€‚

---

### æ‰‹å‹•ç®¡ç†è¨˜æ†¶é«”ï¼š

é™¤äº† JavaScript è‡ªå‹•åƒåœ¾å›æ”¶ï¼Œæˆ‘å€‘é‚„å¯ä»¥æ‰‹å‹•ç®¡ç†è¨˜æ†¶é«”ï¼Œä¾‹å¦‚ä½¿ç”¨ `WeakRef` ã€`WeakMap`ã€`WeakSet` åªä¿ç•™å¼±å¼•ç”¨ï¼Œæˆ–ä½¿ç”¨ `FinalizationRegistry` ç›£è½æ¸…é™¤äº‹ä»¶ï¼Œä¸å½±éŸ¿åƒåœ¾å›æ”¶ã€‚

#### WeakRef

`WeakRef` åªä¿ç•™å¼±å¼•ç”¨ï¼Œä¸å½±éŸ¿åƒåœ¾å›æ”¶ã€‚

```c
const obj = { name: 'Alice' };
const ref = new WeakRef(obj);

obj = null;  // å¦‚æœæ²’æœ‰å…¶ä»–å¼•ç”¨ï¼ŒGC æœƒæ¸…æ‰

console.log(ref.deref()) // æœ‰å¯èƒ½æ‹¿åˆ°ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ undefined
```

å‡è¨­ä½ æœ‰å€‹å¿«å–ç³»çµ±ï¼Œæœƒä¿ç•™ä¸€äº›è³‡æ–™çš„åƒç…§ï¼Œä½†ä½ åˆä¸å¸Œæœ›å®ƒé˜»æ­¢ GC é‡‹æ”¾è¨˜æ†¶é«”ï¼Œé€™æ™‚å°±å¯ä»¥é€™æ¨£å¯«ï¼š

```
let cache = new Map()

function getData(key) {
  const cached = cache.get(key)?.deref()
  if (cached) return cached

  const newData = heavyComputation(key)
  cache.set(key, new WeakRef(newData))
  return newData
}
```

#### FinalizationRegistry

æœ‰æ™‚ä½ æœƒå¸Œæœ›åœ¨ç‰©ä»¶è¢«å›æ”¶å¾Œã€Œåšäº›äº‹ã€ï¼Œä¾‹å¦‚æ¸…ç†è³‡æºæˆ–çµ±è¨ˆç”¨é€”ï¼š

```c
const registry = new FinalizationRegistry((value) => {
  console.log(`ç‰©ä»¶ ${value} è¢«æ¸…é™¤äº†`)
})

let user = { name: 'Tom' }
registry.register(user, 'user1')
user = null // ç•¶ GC æ¸…æ‰é€™å€‹ç‰©ä»¶ï¼Œå°±æœƒè§¸ç™¼ callback
```

ä¸éè¦æ³¨æ„ï¼Œ`WeakRef` å’Œ `FinalizationRegistry` æ˜¯é€²éšåŠŸèƒ½ï¼Œä¸æ˜¯å¸¸ç”¨å·¥å…·ã€‚ä¸æ‡‰è©²ä¾è³´ `FinalizationRegistry` ä¾†åšä¸»é‚è¼¯æ§åˆ¶ï¼Œå› ç‚ºå®ƒä¸ä¿è­‰ç«‹å³åŸ·è¡Œã€‚

---

### è¨˜æ†¶é«”æ´©æ¼ï¼ˆMemory Leakï¼‰ï¼šä»€éº¼æƒ…æ³ä¸‹è³‡æ–™æ¸…ä¸æ‰ï¼Ÿ

å„˜ç®¡æœ‰è‡ªå‹•åƒåœ¾å›æ”¶ï¼ŒJS é‚„æ˜¯æœ‰å¯èƒ½ç”¢ç”Ÿ**è¨˜æ†¶é«”æ´©æ¼**ï¼Œæ„æ€æ˜¯ **ã€Œä¸å†éœ€è¦çš„è³‡æ–™é‚„ä½”è‘—ç©ºé–“æ²’è¢«é‡‹æ”¾ã€**ã€‚
å¸¸è¦‹çš„è¨˜æ†¶é«”æ´©æ¼æƒ…æ³ï¼š

- å…¨åŸŸè®Šæ•¸æœªé‡‹æ”¾ï¼šæ„å¤–å°‡è®Šæ•¸æ›åœ¨ window ä¸Š

- é–‰åŒ…é€ æˆçš„å¼•ç”¨ï¼šå‡½å¼æ²’é‡‹æ”¾å…§éƒ¨å¼•ç”¨ã€‚èˆ‰ä¾‹ï¼š

  ```c
  function leaky() {
    const bigArray = new Array(1000000).fill('ğŸ˜µ')
    return function() {
      console.log(bigArray[0]) // é€™è£¡è®“ bigArray ä¸€ç›´è¢«å¼•ç”¨ï¼Œé‡‹æ”¾ä¸æ‰
    }
  }

  ```

  ä¿®æ­£æ–¹å¼ï¼šé¿å…ä¸å¿…è¦çš„é–‰åŒ…å¼•ç”¨
  å¦‚æœä½ åªéœ€è¦ `bigArray[0]`ï¼Œæ²’å¿…è¦æŠŠæ•´å€‹ `bigArray` ä¿ç•™ä¸‹ä¾†ï¼Œå¯ä»¥åœ¨é–‰åŒ…å¤–å…ˆå–å€¼ï¼š

  ```c
  function leaky() {
    const bigArray = new Array(1000000).fill('ğŸ˜µ')
    const firstValue = bigArray[0] // åªä¿ç•™éœ€è¦çš„éƒ¨åˆ†
    return function() {
      console.log(firstValue) // åªå¼•ç”¨ firstValueï¼Œé‡‹æ”¾ bigArray
    }
  }
  ```

  é€™æ¨£ `bigArray` åœ¨ `leaky()` åŸ·è¡ŒçµæŸå¾Œå°±æœƒè¢«é‡‹æ”¾ã€‚

- ç›£è½å™¨æ²’ç§»é™¤ï¼šaddEventListener åŠ äº†ä½†æ²’ç”¨ removeEventListener æ‹¿æ‰ã€‚

- è¢«éºå¿˜çš„è¨ˆæ™‚å™¨å’Œå›èª¿ï¼šæœªæ¸…ç†çš„ setInterval æˆ–äº‹ä»¶ç›£è½å™¨ã€‚

- DOM è¢«ç§»é™¤ä½†é‚„è¢«å¼•ç”¨ï¼šåˆªé™¤çš„ç¯€é»é‚„è¢« JS è®Šæ•¸å­˜è‘—ã€‚èˆ‰ä¾‹ï¼š

  ```c
  let leakyDiv = document.createElement('div')
  leakyDiv.textContent = 'I will leak!'

  // åŠ åˆ° DOM ä¸­
  document.getElementById('container').appendChild(leakyDiv)

  // ç¨å¾Œç§»é™¤é€™å€‹å…ƒç´ 
  document.getElementById('container').removeChild(leakyDiv)

  // ä½† leakyDiv é‚„åœ¨ JS è£¡è¢«å¼•ç”¨è‘—ï¼Œç„¡æ³•å›æ”¶
  console.log(leakyDiv.textContent) // "I will leak!"
  ```

#### é¿å…è¨˜æ†¶é«”æ´©æ¼çš„æ–¹æ³•ï¼š

- ä½¿ç”¨åš´æ ¼æ¨¡å¼ ("use strict") é¿å…æ„å¤–å…¨åŸŸè®Šæ•¸ã€‚
- ç§»é™¤ä¸éœ€è¦çš„äº‹ä»¶ç›£è½å™¨å’Œè¨ˆæ™‚å™¨ã€‚
- æ³¨æ„ä¿æŒé–‰åŒ…çš„ç¯„åœç›¡å¯èƒ½å°ã€‚
- ä½¿ç”¨ WeakMap å’Œ WeakSet å­˜å„²å°ç‰©ä»¶çš„å¼±å¼•ç”¨ã€‚
- ä½¿ç”¨é–‹ç™¼å·¥å…·å¦‚ Chrome DevTools çš„ Memory é¢æ¿æª¢æ¸¬è¨˜æ†¶é«”æ´©æ¼ã€‚

---

ä¸‹é¢å°å·¥å…·æ¨¡æ“¬äº†æ“ä½œè¨˜æ†¶é«”ç®¡ç†çš„å·¥å…·ï¼Œå¹«åŠ©ä½ äº†è§£è¨˜æ†¶é«”ç®¡ç†çš„åŸç†ã€‚

<JsStorage />
