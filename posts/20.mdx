---
title: Nuxt SSR èˆ‡ Hydration å®Œæ•´è§£æï¼šå¾æµç¨‹ã€é™·é˜±åˆ°æœ€ä½³å¯¦è¸
date: 2025-05-19
category: framework
abstract: ç•¶æˆ‘å€‘ä½¿ç”¨ Nuxt å»ºç«‹ SSRï¼ˆServer Side Renderingï¼‰æ‡‰ç”¨æ™‚ï¼Œé›–ç„¶èƒ½å¤§å¹…æå‡é¦–å±é€Ÿåº¦èˆ‡ SEO å‹å–„åº¦ï¼Œä½†åœ¨ç€è¦½å™¨å•Ÿç”¨ Vue æ‡‰ç”¨å‰ï¼Œç•«é¢ä»æ˜¯éœæ…‹çš„ã€‚é€™å€‹å¾ã€Œéœæ…‹ HTMLã€è®Šæˆã€Œå¯äº’å‹•æ‡‰ç”¨ã€çš„éç¨‹ï¼Œæ­£æ˜¯ hydration çš„é—œéµä»»å‹™ã€‚
tags: [Hydrationã€Nuxtã€SSR]
---

### ç‚ºä»€éº¼éœ€è¦ hydrationï¼Ÿ

ç•¶ä½¿ç”¨ SSR æ™‚ï¼ŒNuxt æœƒåœ¨ä¼ºæœå™¨ä¸Šç”Ÿæˆ HTML çµ¦ç€è¦½å™¨ï¼Œé€™æ¨£å¯ä»¥**åŠ å¿«é¦–å±åŠ è¼‰é€Ÿåº¦ï¼ˆSEO å‹å¥½ï¼‰**ï¼Œä½†é€™æ™‚é é¢ä¸Šçš„äº’å‹•ï¼ˆåƒé»æ“ŠæŒ‰éˆ•ã€æ‰“é–‹ modalï¼‰é‚„ä¸èƒ½ç”¨ï¼Œå› ç‚ºç€è¦½å™¨é‚„æ²’åŠ è¼‰å°æ‡‰çš„ Vue é‚è¼¯ã€‚

Hydration çš„ç›®çš„æ˜¯ï¼š

- è®“é€™å€‹ HTML è®ŠæˆçœŸæ­£çš„ Vue æ‡‰ç”¨ï¼Œ**é™„ä¸Šäº‹ä»¶ç›£è½å™¨ã€éŸ¿æ‡‰å¼è³‡æ–™ç­‰åŠŸèƒ½**ã€‚

- å°ä½¿ç”¨è€…ä¾†èªªï¼Œç•«é¢çœ‹èµ·ä¾†å·²ç¶“ã€Œå¥½äº†ã€ï¼Œäº’å‹•åŠŸèƒ½ä¹Ÿæœƒåœ¨å¹¾ç™¾æ¯«ç§’å…§å®Œæˆå•Ÿç”¨ã€‚

### Hydration çš„éç¨‹ï¼ˆä»¥ Nuxt ç‚ºä¾‹ï¼‰

Hydration çš„éç¨‹ï¼ˆä»¥ Nuxt ç‚ºä¾‹ï¼‰

###### 1.Server Side Renderingï¼ˆSSRï¼‰ï¼š

- Nuxt åœ¨ä¼ºæœå™¨ä¸Šæ ¹æ“šè·¯ç”±ã€è³‡æ–™æŠ“å–ã€çµ„ä»¶ç­‰ç”Ÿæˆéœæ…‹ HTMLã€‚

- åŒæ™‚ä¹ŸæŠŠæ‡‰ç”¨ç‹€æ…‹ï¼ˆå¦‚ propsã€Vuex/Pinia ç‹€æ…‹ã€asyncData çš„çµæœï¼‰åºåˆ—åŒ–æˆ **JSON** æ³¨å…¥é é¢ä¸­ã€‚

```js
// åœ¨ server
const { data } = await useFetch('/api/posts') // æœƒçœŸçš„å»æ‰“ API

// Nuxt æœƒæŠŠ `data` æ”¾é€² HTML è£¡ï¼Œå¦‚ä¸‹ï¼š
<script type="application/json" id="__NUXT__">
{
  "data": {
    "some-key": { posts: [...] } // æ‰“å¥½çš„ API çµæœ
  }
}
</script>

// client hydration æ™‚ï¼ŒVue çµ„ä»¶æœƒç›´æ¥æ‹¿é€™æ®µè³‡æ–™ï¼Œä¸æœƒå†æ‰“ä¸€æ¬¡ API
```

###### 2. ç€è¦½å™¨æ”¶åˆ° HTMLï¼š

- ä½¿ç”¨è€…çœ‹åˆ°çš„æ˜¯ã€Œå¯è¦–çš„éœæ…‹ HTMLã€ï¼Œä½†é€™æ™‚é‚„ä¸èƒ½äº’å‹•ï¼ˆäº‹ä»¶ç›£è½å™¨å°šæœªè¨»å†Šï¼‰ã€‚

###### 3. Nuxt å®¢æˆ¶ç«¯åŠ è¼‰ï¼š

- ç€è¦½å™¨ä¸‹è¼‰ JavaScript bundleï¼ˆVue runtime + æ‡‰ç”¨ç¨‹å¼é‚è¼¯ï¼‰ã€‚

###### 4. Hydration ç™¼ç”Ÿï¼š

- Vue æœƒã€Œæ¯”å°ã€ä¼ºæœå™¨ç”Ÿæˆçš„ DOM å’Œå®¢æˆ¶ç«¯æ¨¡æ¿ render å‡ºä¾†çš„ DOMï¼Œç¢ºä¿ä¸€è‡´æ€§ã€‚

- è‹¥ä¸€è‡´ï¼ŒVue å°±æœƒæ›ä¸Šäº‹ä»¶ç›£è½å™¨ã€éŸ¿æ‡‰å¼ç³»çµ±ç­‰ï¼Œé é¢è®Šå¾—å¯äº’å‹•ã€‚

- è‹¥ä¸ä¸€è‡´ï¼ˆä¾‹å¦‚ SSR å’Œ client æ¸²æŸ“çµæœä¸åŒï¼‰ï¼ŒVue æœƒè­¦å‘Š hydration mismatchï¼Œæœ‰å¯èƒ½æœƒå¼·åˆ¶é‡å»ºè©²éƒ¨åˆ† DOMã€‚

###### 5. é é¢é€²å…¥äº’å‹•ç‹€æ…‹ï¼š

- æ­¤æ™‚æ‰€æœ‰ Vue çš„åŠŸèƒ½ï¼ˆclickã€watchã€computedã€emit ç­‰ï¼‰éƒ½å¯æ­£å¸¸ä½¿ç”¨ã€‚

#### hydration mismatch

- SSR å’Œ CSR æ¸²æŸ“çµæœå¿…é ˆä¸€è‡´ã€‚å¦å‰‡æœƒå‡ºç¾è­¦å‘Šæˆ– UI ç•°å¸¸ã€‚

- ä¾‹å¦‚ä½¿ç”¨ `Date.now()`ã€`Math.random()`ã€`window`ã€`localStorage` ç­‰åªèƒ½åœ¨ client å­˜å–çš„æ±è¥¿æ™‚ï¼Œè¦å°å¿ƒã€‚

è§£æ³•ï¼š

- ä½¿ç”¨ `<ClientOnly> `åŒ…èµ·ä¾†

- ä½¿ç”¨ `process.client` åˆ¤æ–·æ˜¯å¦åœ¨ client åŸ·è¡Œ

### Nuxt SSR + Hydration æ•´é«”æµç¨‹åœ–

```
Serverï¼š
- åŸ·è¡Œçµ„ä»¶é‚è¼¯ï¼ˆsetupã€asyncDataã€useFetchï¼‰
- ç”Ÿæˆéœæ…‹ HTML
- å°‡è³‡æ–™ JSON æ³¨å…¥é é¢ï¼ˆ__NUXT__ stateï¼‰

â­£ å‚³é€ HTML + JSON åˆ° Client

Clientï¼š
- åŠ è¼‰ HTML
- åŠ è¼‰ JS bundle
- Hydration éç¨‹ï¼š
   - æ¯”å° DOM çµæ§‹
   - æ›ä¸Šäº‹ä»¶ & éŸ¿æ‡‰ç³»çµ±
   - ç”¨ __NUXT__ state é¿å…é‡è¤‡æ‰“ API
- æ‡‰ç”¨è®Šå¾—å¯äº’å‹•
```

---

#### å¯¦ä¾‹èªªæ˜

æˆ‘å€‘çŸ¥é“ `setup()` åŒæ™‚æœƒåœ¨ server è·Ÿ client å„åŸ·è¡Œä¸€æ¬¡

- **åœ¨ server æ¸²æŸ“éšæ®µ**ï¼šNuxt æœƒè·‘ `setup()`ï¼ŒæŠŠçµæœç”¨ä¾† render HTMLã€‚

- **åœ¨ client hydration éšæ®µ**ï¼šç€è¦½å™¨ç«¯æœƒå†æ¬¡åŸ·è¡Œ `setup()`ï¼Œä½†é€™æ¬¡ä¸ render HTMLï¼Œè€Œæ˜¯å»ºç«‹éŸ¿æ‡‰ç³»çµ±ã€äº‹ä»¶ç¶å®šç­‰ï¼Œå®Œæˆ hydrationã€‚

ä¸€èˆ¬ä¾†èªªï¼Œåœ¨ server æ‰“é api æ‹¿éçš„è³‡æ–™ï¼Œclient å°±ä¸æœƒåœ¨æ‰“ä¸€æ¬¡ï¼Œå‡è¨­æˆ‘å€‘æœ‰ä¸€å€‹é é¢ï¼Œè¦æŠ“ç†±é–€æ–‡ç«  `/api/hot-posts`

```vue
<script setup>
// é€™æ®µæœƒåœ¨ server ç«¯åŸ·è¡Œï¼ˆä¹Ÿæœƒåœ¨ client ç«¯åŸ·è¡Œ hydration æ™‚å†æ¬¡åŸ·è¡Œï¼‰
const { data, pending } = await useFetch('/api/hot-posts')
</script>

<template>
  <div>
    <h1>ğŸ”¥ ç†±é–€æ–‡ç« </h1>
    <ul v-if="!pending">
      <li v-for="post in data" :key="post.id">{{ post.title }}</li>
    </ul>
  </div>
</template>
```

###### Server ç«¯æœƒæ€éº¼åšï¼Ÿ

åŸ·è¡Œ `useFetch('/api/hot-posts')`ï¼Œæ‰“ API æ‹¿è³‡æ–™ã€‚

```json
[
  { "id": 1, "title": "Hydration æ˜¯ä»€éº¼ï¼Ÿ" },
  { "id": 2, "title": "Vue çš„ reactivity åŸç†" }
]
```

ç”¨é€™äº›è³‡æ–™ render å‡º HTMLï¼š

```html
<ul>
  <li>Hydration æ˜¯ä»€éº¼ï¼Ÿ</li>
  <li>Vue çš„ reactivity åŸç†</li>
</ul>
```

åŒæ™‚ï¼ŒæŠŠè³‡æ–™å­˜é€² __NUXT__ hydration payloadï¼š
```html
<script id="__NUXT__" type="application/json">
{
  "data": {
    "hot-posts-key": [ { "id": 1, "title": "..." }, ... ]
  }
}
</script>
```

###### Client ç«¯æœƒæ€éº¼åšï¼Ÿ

1. é é¢è¼‰å…¥æ™‚ï¼ŒVue æª¢æŸ¥ `__NUXT__` ä¸­æ˜¯å¦å·²æœ‰è³‡æ–™ã€‚

2. æœ‰çš„è©±ï¼Œä¸æœƒé‡æ–°æ‰“ APIï¼Œç›´æ¥ä½¿ç”¨ hydration stateã€‚

3. `useFetch()` æª¢æŸ¥å·²å­˜åœ¨çš„ cacheï¼Œç›´æ¥å›å‚³è³‡æ–™ã€‚

4. å®Œæˆ hydrationã€å•Ÿç”¨äº’å‹•æ€§ï¼ˆäº‹ä»¶ç›£è½ã€ref åæ‡‰å¼ç­‰ï¼‰ã€‚

---

ä½†æ˜¯ï¼Œæœ‰äº›æƒ…æ³ä¸‹ server å’Œ client å…©é‚Šéƒ½è¦æ‰“ä¸€æ¬¡ APIï¼š

æ¯”è¼ƒå¸¸è¦‹çš„æƒ…æ³æ˜¯ï¼Œ**è³‡æ–™è·Ÿã€Œä½¿ç”¨è€…èº«åˆ†æˆ–ç‹€æ…‹ã€æœ‰é—œã€‚**

- ç™»å…¥ä½¿ç”¨è€…è³‡è¨Šå­˜åœ¨ cookie æˆ– token ä¸­

- Server æ‰“ API ç”¨ä¼ºæœå™¨çš„ cookie

- Client hydration å¾Œéœ€è¦æ ¹æ“š client ç‹€æ…‹å†æ‰“ä¸€æ¬¡ç¢ºèªç™»å…¥æˆ–é‡æ–°å–å¾—

æ¯”æ–¹èªªï¼Œserver side æ²’ç™»å…¥ï¼Œä½† client side æœ‰ç™»å…¥ï¼Œç•«é¢æœƒæœ‰å·®åˆ¥ï¼Œé€™æ™‚å°±æœƒ å‡ºç¾ hydration mismatchã€‚æˆ–æ˜¯Server SSR ä½¿ç”¨ä¼ºæœå™¨ cookieï¼ŒClient ç«¯ hydration æ™‚ï¼Œå¯èƒ½å› ç‚º token éæœŸã€cookie ä¸å­˜åœ¨æˆ–åˆ‡æ› userï¼Œéœ€è¦å†ç¢ºèªä¸€æ¬¡

```vue
<!-- pages/profile.vue -->
<script setup>
import { useFetch } from '#app'
import { onMounted } from 'vue'
import { useUserStore } from '~/stores/user'

// Server ç«¯ï¼šä½¿ç”¨ä¼ºæœå™¨ cookie æ‰“ API æ‹¿ä½¿ç”¨è€…è³‡è¨Š
const { data: user, refresh } = await useFetch('/api/user', {
  key: 'user',
  server: true,  // Server SSR éšæ®µæœƒæ‰“
  lazy: false,
  default: () => null,
})

// client hydration å¾Œå†æ‰“ä¸€æ¬¡ API å–å¾—æœ€æ–°ç‹€æ…‹
onMounted(async () => {
  const { status } = await refresh()
  console.log('[Client Refresh] /api/user status:', status)
  // â• æ›´æ–° Pinia store æˆ–æœ¬åœ° state
  if (user.value) {
    useUserStore().setUser(user.value)
  }
})
</script>

<template>
  <div>
    <h1>æœƒå“¡ä¸­å¿ƒ</h1>
    <p v-if="user">Hi, {{ user.name }}</p>
    <p v-else>å°šæœªç™»å…¥</p>
  </div>
</template>
```

ä½ å¯ä»¥åŠ ä¸Š flag æ¯”å°çµæœï¼Œé¿å…é‡è¤‡ request æˆ–åŠ  loading ç‹€æ…‹ï¼š

```
onMounted(async () => {
  const oldUser = user.value?.id
  const { data: newUser } = await refresh()
  if (newUser.value?.id !== oldUser) {
    console.log('Client user info updated:', newUser.value)
  }
})
```

- `server/api/user.ts` é©—è­‰ JWTï¼ˆNuxt API routeï¼‰

```ts
// å‡è¨­é€™æ˜¯å¾ cookie é©—è­‰ token æ‹¿åˆ° user è³‡è¨Š
export default defineEventHandler(async (event) => {
  const token = getCookie(event, 'access_token')
  if (!token) return null
  const payload = verify(token) // â† é©—è­‰ JWT
  return { id: payload.sub, name: payload.name }
})

```

è£œå……èªªæ˜ä¸€ä¸‹å¦‚ä½•å¸¶ä¸Š cookieï¼šç€è¦½å™¨æ‰èƒ½è‡ªå‹•é™„å¸¶ cookieï¼ŒServer ä¸è¡Œè‡ªå‹•ï¼Œä½†å¯ä»¥ã€Œè‡ªå·±æ‰‹å‹•å–å¾—ã€ç„¶å¾Œã€Œè‡ªå·±é™„å¸¶ä¸Šå»ã€ã€‚

```
ğŸ§‘ ä½¿ç”¨è€… (Browser)
    |
    | â‘  è«‹æ±‚ç•«é¢ GET /dashboard
    |    â¬†ï¸ Cookie æœƒè¢«è‡ªå‹•é™„åŠ åœ¨ request headers è£¡
    â†“
ğŸŒ Nuxt Server (Node.js ç’°å¢ƒ)
    |
    | â‘¡ æ¥æ”¶åˆ° request â†’ é–‹å§‹ SSR
    |    åœ¨ <script setup> æˆ– asyncData/useFetch è§¸ç™¼è³‡æ–™ç²å–é‚è¼¯
    |
    | â‘¢ åœ¨ useFetch ä¸­ç”¨ `useRequestHeaders(['cookie'])` æˆ– `getCookie` æ‹¿ cookie
    |    æ‰‹å‹•åŠ åˆ° `$fetch` headers è£¡ï¼šç­‰æ–¼è‡ªå·±å¹« request åŠ  cookie
    â†“
ğŸ“¦ Nuxt API Route (`/api/user`)
    |
    | â‘£ é©—è­‰ cookie è£¡çš„ JWT â†’ å›å‚³ user è³‡æ–™
    â†“
ğŸŒ Nuxt Server
    |
    | â‘¤ SSR çµæŸï¼ŒæŠŠ HTMLï¼ˆå« user è³‡æ–™ï¼‰é€çµ¦ç€è¦½å™¨
    â†“
ğŸ§‘ ä½¿ç”¨è€… (Browser)
    |
    | â‘¥ é–‹å§‹ hydrationï¼Œclient-side çš„ Vue å•Ÿå‹•
    |    å¦‚æœ useFetch æ²’æœ‰ cacheï¼Œå°±æœƒå†æ‰“ä¸€æ¬¡ APIï¼ˆè‡ªå‹•å¸¶ cookieï¼‰
    â†“
ğŸ“¦ Nuxt API Route
    |
    | â‘¦ é©—è­‰ cookieï¼Œå†æ¬¡å›å‚³ user è³‡æ–™
```

å¦‚æœ JWT æ²’æœ‰å­˜åœ¨ cookie ï¼Œè€Œå·²æœ‰å­˜åœ¨ localStorage çš„è©±è©²æ€éº¼åšå‘¢ï¼Ÿserver side ä¸èƒ½ç²å–å¯¸åœ¨ localStorage çš„ tokenï¼Œä½†å¯ä»¥åœ¨ middleware client å…ˆå»ç²å– localStorage å­˜åœ¨ piniaï¼Œé€™æ¨£åœ¨ server å°±å¯ä»¥å»ç²å– tokenã€‚


é€™æ®µæœƒåœ¨ client-side æ™‚ï¼Œå°‡ localStorage è£¡çš„ token å­˜é€² Piniaã€‚

```ts
// middleware/auth.global.ts

export default defineNuxtRouteMiddleware((to, from) => {
  if (process.client) {
    const token = localStorage.getItem('access_token')
    const userStore = useUserStore()

    if (token && !userStore.token) {
      userStore.setToken(token)
    }
  }
})

```

æ¥è‘—ï¼Œåœ¨é é¢ä¸­é€™æ¨£ä½¿ç”¨ï¼š

```ts
const userStore = useUserStore()

await useFetch('/api/user', {
  headers: {
    Authorization: `Bearer ${userStore.token}`
  }
})
```

#### çµèª
Hydration æ˜¯ Nuxt SSR å¾ˆé‡è¦çš„è§€å¿µï¼Œç†è§£ hydration çš„æµç¨‹ã€è³‡æ–™å‚³éæ©Ÿåˆ¶èˆ‡ client-server ä¸ä¸€è‡´çš„ç‹€æ³ï¼Œå¯ä»¥é¿å…ç¨‹å¼ç¢¼ Crush çš„æ©Ÿç‡ã€‚ç‰¹åˆ¥æ³¨æ„ client-only çš„è³‡æ–™ä¾†æºï¼ˆå¦‚ localStorageï¼‰èˆ‡ server side çš„ cookie ä¸²æ¥æ–¹å¼ã€‚æŒæ¡ useFetch çš„åŸ·è¡Œæ™‚æ©Ÿã€useRequestHeaders çš„ä½¿ç”¨æ–¹å¼ï¼Œåœ¨å¯¦ä½œæœƒæœ‰å¾ˆå¤§çš„å¹«åŠ©ã€‚
